<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekly Timetable ‚Äì Glass Edition Enhanced (Notifications)</title>
<style>
  :root{
    --glass-bg: rgba(15,23,42,0.28);
    --glass-border: rgba(148,163,184,0.6);
    --accent: #38bdf8;
    --accent-soft: rgba(56,189,248,0.25);
    --danger: #fb7185;
    --text-main: #e5e7eb;
    --text-muted: #9ca3af;
    --tab-active-start: #4F8BFF;
    --tab-active-end: #6CA8FF;
    --tab-inactive: rgba(255,255,255,0.04);
    --tab-hover: rgba(76,154,255,0.12);
    --bg-gradient-1: #0ea5e9;
    --bg-gradient-2: #020617;
    --bg-gradient-3: #6366f1;
    --card-bg-start: rgba(15,23,42,0.76);
    --card-bg-end: rgba(15,23,42,0.92);
    --table-row-even: rgba(15,23,42,0.65);
    --table-row-hover: rgba(15,23,42,0.92);
    --control-bg: rgba(15,23,42,0.85);
  }
  /* Light theme variables - default */
  [data-theme="light"] {
    --glass-bg: rgba(255,255,255,0.42);
    --glass-border: rgba(100,116,139,0.35);
    --accent: #0284c7;
    --accent-soft: rgba(2,132,199,0.15);
    --danger: #dc2626;
    --text-main: #1e293b;
    --text-muted: #64748b;
    --tab-active-start: #0ea5e9;
    --tab-active-end: #38bdf8;
    --tab-inactive: rgba(0,0,0,0.04);
    --tab-hover: rgba(14,165,233,0.15);
    --bg-gradient-1: #38bdf8;
    --bg-gradient-2: #f8fafc;
    --bg-gradient-3: #818cf8;
    --card-bg-start: rgba(255,255,255,0.88);
    --card-bg-end: rgba(255,255,255,0.96);
    --table-row-even: rgba(241,245,249,0.6);
    --table-row-hover: rgba(226,232,240,0.8);
    --control-bg: rgba(248,250,252,0.9);
  }
  /* Dark theme fallback */
  [data-theme="dark"] {
    --glass-bg: rgba(15,23,42,0.28);
    --text-main: #e5e7eb;
    --text-muted: #9ca3af;
    --card-bg-start: rgba(15,23,42,0.76);
    --card-bg-end: rgba(15,23,42,0.92);
    --control-bg: rgba(10,15,25,0.9);
  }
  [data-theme="light"] .gap-chip {
  color: var(--text-main);
  }
  [data-theme="dark"] .gap-chip {
  color: var(--text-main);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    min-height:100vh;padding:20px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background: radial-gradient(circle at 0% 0%, var(--bg-gradient-1) 0, var(--bg-gradient-2) 40%),
                radial-gradient(circle at 100% 100%, var(--bg-gradient-3) 0, var(--bg-gradient-2) 40%);
    color:var(--text-main);display:flex;align-items:center;justify-content:center;
    transition: background 0.3s ease, color 0.2s ease;
  }
  /* Prevent notification popup from going off-screen */
  .notify-menu {
  right: 0 !important;
  left: auto !important;
  transform: translateX(-10px); /* pulls it slightly inward */
  max-width: 240px;
  overflow-wrap: break-word;
  }

  .shell{width:100%;max-width:1400px}
  .card{
    width:100%;
    background: linear-gradient(145deg, var(--card-bg-start), var(--card-bg-end));
    border-radius:20px; box-shadow: 0 24px 60px rgba(15,23,42,0.12);
    border:1px solid var(--glass-border); backdrop-filter: blur(18px) saturate(140%);
    overflow:hidden;
  }

  /* header top */
  .header{
    padding:18px 20px 12px;
    border-bottom:1px solid var(--glass-border);
  }
  .title-row{
    display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;
  }
  .title-block{display:flex;flex-direction:column;gap:4px}
  h1{font-size:20px;font-weight:700;letter-spacing:0.02em;display:flex;align-items:center;gap:10px}
  h1 .badge{font-size:12px;padding:3px 10px;border-radius:999px;background: rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.25);color:#166534}
  .subtitle{font-size:13px;color:var(--text-muted)}

  .theme-toggle{
    width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    border:1px solid var(--glass-border); background: radial-gradient(circle at 0 0, var(--accent-soft), transparent 50%), var(--control-bg);
    cursor:pointer; font-size:18px; transition: all .25s ease;
  }

  /* notification bell */
  .notif-toggle{
    width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    border:1px solid var(--glass-border); background: radial-gradient(circle at 0 0, rgba(255,255,255,0.02), transparent 50%), var(--control-bg);
    cursor:pointer; font-size:18px; transition: all .25s ease; margin-left:8px;
    position:relative;
  }
  /* glow animation when enabled */
  .notif-enabled {
    box-shadow: 0 0 12px 2px rgba(56,189,248,0.18), 0 0 24px 6px rgba(56,189,248,0.06);
    animation: pulseGlow 3s infinite;
  }
  @keyframes pulseGlow{
    0%{ box-shadow:0 0 6px 0 rgba(56,189,248,0.12); transform:translateY(0) }
    50%{ box-shadow:0 0 18px 6px rgba(56,189,248,0.16); transform:translateY(-1px) }
    100%{ box-shadow:0 0 6px 0 rgba(56,189,248,0.12); transform:translateY(0) }
  }

  /* line 1 group */
  .top-line{
    display:flex;align-items:center;justify-content:center;gap:18px;padding:10px 12px 0;
    flex-wrap:wrap;
  }
  .tabs-container{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tab{
    padding:8px 12px;border-radius:999px;font-size:14px;font-weight:700;cursor:pointer;color:var(--text-main);
    background:var(--tab-inactive);border:1px solid rgba(255,255,255,0.06);min-width:56px;text-align:center;
  }
  .tab:hover{background:var(--tab-hover);transform:translateY(-2px)}
  .tab.active{background:linear-gradient(135deg,var(--tab-active-start),var(--tab-active-end));color:#fff;box-shadow:0 8px 20px rgba(0,0,0,0.12);transform:translateY(-3px)}

  .line1-controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .gap-chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--glass-border);background:var(--control-bg);cursor:pointer;font-weight:700}
  .gap-chip .clock{font-size:15px}
  .clear-btn{margin-left:6px}

  /* reminder panel (inside bell) */
  .reminder-panel{padding:10px;min-width:220px}
  .reminder-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .reminder-num{width:86px;padding:8px;border-radius:8px;border:1px solid var(--glass-border);background:var(--control-bg);color:var(--text-main);text-align:center;font-size:14px}

  /* line 2 group: control panel (rows/cols) */
  .control-panel{
    display:flex;align-items:center;justify-content:center;gap:16px;padding:12px 14px;border-top:1px solid transparent;
    flex-wrap:wrap;background:transparent;
  }
  .control-group{display:flex;align-items:center;gap:8px;padding:6px;border-radius:999px;background: radial-gradient(circle at 0 0, var(--accent-soft), transparent 50%), var(--control-bg);border:1px solid var(--glass-border)}
  .control-label{font-size:11px;text-transform:uppercase;color:var(--text-muted);font-weight:700;margin-right:4px}
  .btn{border:1px solid var(--glass-border);background:transparent;color:var(--text-main);font-size:13px;font-weight:700;padding:8px 12px;border-radius:999px;cursor:pointer}
  .btn:hover{border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-soft)}
  .btn-danger{background: radial-gradient(circle at 0 0, rgba(248,113,113,0.08), transparent 55%);border:1px solid rgba(248,113,113,0.25);color:var(--danger);}

  /* dropdown menu */
  .dropdown{position:relative}
  .dropdown-menu{
    position:absolute;top:calc(100% + 10px);left:0;min-width:160px;padding:8px;border-radius:12px;background:var(--card-bg-end);
    border:1px solid var(--glass-border);box-shadow:0 16px 40px rgba(0,0,0,0.08);display:none;z-index:200;
  }
  .dropdown-menu.open{display:block}
  .dropdown-item{padding:8px 10px;border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .dropdown-item:hover{background:var(--accent-soft)}

  /* table */
  .body-section{padding:14px}
  .table-wrap{border-radius:12px;padding:14px;background: radial-gradient(circle at 0 0, var(--accent-soft), transparent 55%), var(--control-bg);border:1px solid var(--glass-border);overflow:auto}
  table{width:100%;min-width:780px;border-collapse:collapse}
  th{font-size:12px;color:var(--text-muted);padding:12px;text-align:left;border-bottom:2px solid var(--glass-border);position:sticky;top:0;background:var(--card-bg-end)}
  td{font-size:14px;padding:12px;border-bottom:1px solid var(--glass-border);color:var(--text-main)}
  tbody tr:nth-child(2n) td{background:var(--table-row-even)}
  tbody tr:hover td{background:var(--table-row-hover);box-shadow:0 0 0 2px var(--accent-soft)}
  td[contenteditable="true"]{cursor:text;border-radius:8px}
  td[contenteditable="true"]:focus{outline:2px solid var(--accent);outline-offset:-2px;box-shadow:0 0 0 4px var(--accent-soft)}
  td[contenteditable="true"]:empty::before{content:attr(data-placeholder);color:var(--text-muted);font-style:italic}
  .slot-col{text-align:center;width:90px;font-weight:800}
  .time-col{width:150px;font-family:ui-monospace,monospace;cursor:pointer;font-weight:700}
  .activity-col{min-width:240px}
  .custom-col{min-width:160px}

  /* time popup */
  .time-popup{position:absolute;z-index:600;min-width:220px;padding:12px;border-radius:12px;background:var(--card-bg-end);border:1px solid var(--glass-border);display:none;box-shadow:0 18px 40px rgba(0,0,0,0.12)}
  .time-popup-title{font-size:12px;color:var(--text-muted);margin-bottom:8px;font-weight:700}
  .time-row{display:flex;gap:8px;align-items:center}
  .select{padding:8px;border-radius:8px;border:1px solid var(--glass-border);background:var(--control-bg);color:var(--text-main);font-weight:700}

  /* small screens */
  @media(max-width:768px){
    .title-row{flex-direction:column;align-items:flex-start}
    .top-line{flex-direction:column;align-items:flex-start;padding:8px}
    .control-panel{padding:10px;justify-content:flex-start}
    table{min-width:680px}
  }
</style>
</head>
<body>
<div class="shell">
  <div class="card" id="mainCard" aria-live="polite">
    <!-- header -->
    <div class="header">
      <div class="title-row">
        <div class="title-block">
          <h1>Weekly Timetable Builder <span class="badge">Glass</span></h1>
          <div class="subtitle" id="subtitleText">Click start/end to edit time ‚Ä¢ Auto-save per day</div>
        </div>

        <div style="display:flex;align-items:center;gap:8px">
          <!-- notification bell / reminder dropdown -->
          <div class="dropdown" id="notifDropdownWrap">
            <button id="notifToggle" class="notif-toggle" aria-pressed="false" title="Enable reminders">
              <span id="notifIcon">üîï</span>
            </button>
            <div class="dropdown-menu notify-menu" data-menu-panel="notif-panel" id="notifPanel" aria-hidden="true">

              <div class="reminder-panel">
                <div style="font-weight:700;color:var(--text-main);margin-bottom:8px">Remind before start</div>
                <div class="reminder-row">
                  <button class="btn" data-rem="1">1m</button>
                  <button class="btn" data-rem="5">5m</button>
                  <button class="btn" data-rem="10">10m</button>
                  <button class="btn" data-rem="15">15m</button>
                  <button class="btn" data-rem="30">30m</button>
                </div>
                <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                  <input id="reminderCustomInput" class="reminder-num" type="number" min="0" step="1" value="5" aria-label="Custom reminder minutes">
                  <button id="reminderApplyBtn" class="btn">Apply</button>
                </div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:8px">Saved per-day if a day is active. Notifications require permission.</div>
              </div>
            </div>
          </div>

          <!-- theme toggle -->
          <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme"><span id="themeIcon">‚òÄÔ∏è</span></button>
        </div>
      </div>

      <!-- LINE 1: Week tabs | Clear All | Gap -->
      <div class="top-line">
        <div class="tabs-container" id="tabsContainer" aria-label="Week tabs"></div>

        <div class="line1-controls" role="group" aria-label="Line 1 controls">
          <button id="clearAllBtn" class="btn btn-danger clear-btn" title="Clear saved data for all days">üßπ Clear All</button>

          <div class="dropdown">
            <button id="gapBtn" class="gap-chip" data-menu-button="gap-panel" aria-haspopup="true" aria-expanded="false">
              <span class="clock">‚è±</span>
              <span id="gapLabel">Gap: 5 min</span>
            </button>
            <div class="dropdown-menu" data-menu-panel="gap-panel" id="gapPanel" aria-hidden="true">
              <div style="font-weight:700;color:var(--text-main);margin-bottom:8px">Break between periods</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
                <button class="btn" data-gap="1">1 min</button>
                <button class="btn" data-gap="5">5 min</button>
                <button class="btn" data-gap="10">10 min</button>
                <button class="btn" data-gap="15">15 min</button>
                <button class="btn" data-gap="30">30 min</button>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="gapCustomInput" class="gap-num" type="number" min="0" step="1" value="5" aria-label="Custom gap minutes" style="padding:8px;border-radius:8px;border:1px solid var(--glass-border);background:var(--control-bg);color:var(--text-main);width:100px">
                <button id="gapApplyBtn" class="btn">Apply</button>
              </div>
              <div style="font-size:12px;color:var(--text-muted);margin-top:8px">Default used when adding rows. Stored per-day if you open a day first.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- LINE 2: Rows Add/Delete | Columns Add/Delete -->
      <div class="control-panel" id="controlPanel">
        <div class="control-group" role="group" aria-label="Rows controls">
          <div class="control-label">Rows</div>
          <div class="dropdown">
            <button class="btn" data-menu-button="add-rows">‚ûï Add</button>
            <div class="dropdown-menu" data-menu-panel="add-rows">
              <div class="dropdown-item" data-action="add-rows" data-count="1">Add 1 <span>√ó1</span></div>
              <div class="dropdown-item" data-action="add-rows" data-count="2">Add 2 <span>√ó2</span></div>
              <div class="dropdown-item" data-action="add-rows" data-count="4">Add 4 <span>√ó4</span></div>
              <div class="divider"></div>
              <div class="dropdown-item" data-action="add-rows-custom">Custom‚Ä¶</div>
            </div>
          </div>

          <div class="dropdown">
            <button class="btn" data-menu-button="delete-rows">‚ûñ Delete</button>
            <div class="dropdown-menu" data-menu-panel="delete-rows">
              <div class="dropdown-item" data-action="delete-rows" data-count="1">Delete 1</div>
              <div class="dropdown-item" data-action="delete-rows" data-count="2">Delete 2</div>
              <div class="dropdown-item" data-action="delete-rows" data-count="4">Delete 4</div>
              <div class="divider"></div>
              <div class="dropdown-item" data-action="delete-rows-custom">Custom‚Ä¶</div>
            </div>
          </div>
        </div>

        <div class="control-group" role="group" aria-label="Columns controls">
          <div class="control-label">Columns</div>
          <div class="dropdown">
            <button class="btn" data-menu-button="add-cols">üìÑ Add</button>
            <div class="dropdown-menu" data-menu-panel="add-cols">
              <div class="dropdown-item" data-action="add-cols" data-count="1">Add 1</div>
              <div class="dropdown-item" data-action="add-cols" data-count="2">Add 2</div>
              <div class="dropdown-item" data-action="add-cols" data-count="3">Add 3</div>
              <div class="divider"></div>
              <div class="dropdown-item" data-action="add-cols-custom">Custom‚Ä¶</div>
            </div>
          </div>

          <div class="dropdown">
            <button class="btn" data-menu-button="delete-cols">‚úÇÔ∏è Delete</button>
            <div class="dropdown-menu" data-menu-panel="delete-cols">
              <div class="dropdown-item" data-action="delete-cols" data-count="1">Delete 1</div>
              <div class="dropdown-item" data-action="delete-cols" data-count="2">Delete 2</div>
              <div class="divider"></div>
              <div class="dropdown-item" data-action="delete-cols-custom">Custom‚Ä¶</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- table -->
    <div class="body-section">
      <div class="table-wrap">
        <table id="scheduleTable" role="table" aria-label="Weekly schedule">
          <thead>
            <tr id="headerRow">
              <th contenteditable="true" data-col-index="0" data-placeholder="Slot">Slot</th>
              <th contenteditable="true" data-col-index="1" data-placeholder="Start Time">Start Time</th>
              <th contenteditable="true" data-col-index="2" data-placeholder="End Time">End Time</th>
              <th contenteditable="true" data-col-index="3" data-placeholder="Activity">Activity</th>
            </tr>
          </thead>
          <tbody id="scheduleBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- time popup -->
<div id="timePopup" class="time-popup" aria-hidden="true">
  <div class="time-popup-title">Set time</div>
  <div class="time-row">
    <select id="hourSelect" class="select" aria-label="Hour"></select>
    <span style="font-weight:700;font-size:16px">:</span>
    <select id="minuteSelect" class="select" aria-label="Minute"></select>
    <select id="periodSelect" class="select" aria-label="AM/PM">
      <option value="AM">AM</option>
      <option value="PM">PM</option>
    </select>
    <button id="cancelTimeBtn" class="time-btn">Cancel</button>
    <button id="applyTimeBtn" class="time-btn primary">Set</button>
  </div>
</div>

<script>
/* =========================
   Config & helpers
   ========================= */
const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const BASE_KEY = "weekly_schedule_glass_v2";
const THEME_KEY = "weekly_schedule_theme";
const REM_KEY_PREFIX = `${BASE_KEY}_reminder`; // store per-day reminders
const NOTIFIED_PREFIX = `${BASE_KEY}_notified`; // store fired notifications
let currentDay = null;

/* Column metadata */
const REQUIRED_COLS = [
  { index:0, name:"Slot", className:"slot-col", placeholder:"N" },
  { index:1, name:"Start Time", className:"time-col", placeholder:"6:00 AM" },
  { index:2, name:"End Time", className:"time-col", placeholder:"6:45 AM" },
  { index:3, name:"Activity", className:"activity-col", placeholder:"Enter activity..." }
];
function getColMeta(idx){
  const base = REQUIRED_COLS.find(c=>c.index===idx);
  if (base) return base;
  return { index:idx, name:`Column ${idx+1}`, className:"custom-col", placeholder:"Enter..." };
}

/* Time parse/format helpers */
function parseTimeToMinutes(str){
  if (!str) return null;
  const m = String(str).trim().match(/^(\d{1,2}):(\d{2})\s*(AM|PM)?$/i);
  if (!m) return null;
  let hour = parseInt(m[1],10);
  let minute = parseInt(m[2],10);
  let period = (m[3] || "AM").toUpperCase();
  if (hour < 1 || hour > 12) hour = ((hour % 12) + 12) % 12 || 12;
  if (minute < 0 || minute > 59) minute = 0;
  if (period === "PM" && hour !== 12) hour += 12;
  if (period === "AM" && hour === 12) hour = 0;
  return hour*60 + minute;
}
function minutesToTimeString(total){
  total = ((total % (24*60)) + (24*60)) % (24*60);
  let hour24 = Math.floor(total/60);
  let minute = total % 60;
  const period = hour24 >= 12 ? "PM":"AM";
  let hour12 = hour24 % 12;
  if (hour12 === 0) hour12 = 12;
  return `${hour12}:${String(minute).padStart(2,"0")} ${period}`;
}
function addMinutes(str,delta){
  const t = parseTimeToMinutes(str);
  if (t==null) return null;
  return minutesToTimeString(t + delta);
}
function timeDiffMinutes(startStr,endStr){
  const s = parseTimeToMinutes(startStr);
  const e = parseTimeToMinutes(endStr);
  if (s==null || e==null) return null;
  let diff = e - s;
  if (diff <= 0) diff += 24*60;
  return diff;
}

/* =========================
   Theme: light default
   ========================= */
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  const theme = saved || 'light'; // LIGHT default as requested
  applyTheme(theme);
}
function applyTheme(theme){
  const t = (theme === 'light') ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', t);
  const icon = document.getElementById('themeIcon');
  icon.textContent = (t === 'light') ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem(THEME_KEY, t);
}
function toggleTheme(){
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  applyTheme(current === 'light' ? 'dark' : 'light');
}
document.getElementById('themeToggle').addEventListener('click', toggleTheme);

/* =========================
   Storage helpers
   ========================= */
function storageKeyForDay(day){ return `${BASE_KEY}_${day}`; }
function saveForDay(day, data){ localStorage.setItem(storageKeyForDay(day), JSON.stringify(data)); }
function loadFromDay(day){ const raw = localStorage.getItem(storageKeyForDay(day)); try { return raw ? JSON.parse(raw) : null; } catch(e){ return null; } }
function reminderKeyForDay(day){ return `${REM_KEY_PREFIX}_${day}`; }

/* capture table */
function captureTableToData(){
  const headerRow = document.getElementById("headerRow");
  const tbody = document.getElementById("scheduleBody");
  const headers = Array.from(headerRow.children).map(th => th.textContent || "");
  const rows = Array.from(tbody.children).map(tr => Array.from(tr.children).map(td => td.textContent || ""));
  const gap = readGapForDay(currentDay);
  const reminder = readReminderForDay(currentDay);
  return { headers, rows, gapMinutes: gap, reminderMinutes: reminder };
}

/* save current */
function saveTable(){ if (!currentDay) return; saveForDay(currentDay, captureTableToData()); }

/* =========================
   Gap: per-day or global (default 5)
   ========================= */
function readGapForDay(day){
  const raw = loadFromDay(day);
  if (raw && typeof raw.gapMinutes === "number") return raw.gapMinutes;
  const fromUI = Number(localStorage.getItem(`${BASE_KEY}_active_gap`));
  return (!Number.isNaN(fromUI) && Number.isFinite(fromUI) && fromUI >= 0) ? fromUI : 5;
}
function setGapForDay(day, minutes, persistUI = true){
  minutes = Math.max(0, Math.round(Number(minutes) || 0));
  const data = loadFromDay(day) || { headers:["Slot","Start Time","End Time","Activity"], rows:[], gapMinutes:minutes, reminderMinutes: readReminderForDay(day) || 5 };
  data.gapMinutes = minutes;
  saveForDay(day, data);
  document.getElementById("gapLabel").textContent = `Gap: ${minutes} min`;
  if (persistUI) localStorage.setItem(`${BASE_KEY}_active_gap`, String(minutes));
}

/* =========================
   Reminder per-day (for notifications) default 5
   ========================= */
function readReminderForDay(day){
  const raw = localStorage.getItem(reminderKeyForDay(day));
  if (raw !== null) {
    const n = Number(raw);
    if (!Number.isNaN(n) && Number.isFinite(n) && n >= 0) return Math.max(0, Math.round(n));
  }
  return 5;
}
function setReminderForDay(day, minutes, persistUI = true){
  minutes = Math.max(0, Math.round(Number(minutes) || 0));
  localStorage.setItem(reminderKeyForDay(day), String(minutes));
  // update UI if active
  if (day === currentDay) {
    document.getElementById('reminderCustomInput').value = minutes;
  }
  if (persistUI) {
    // nothing else needed; it's stored per-day
  }
}

/* =========================
   Notification permission & UI
   ========================= */
const notifToggleBtn = document.getElementById('notifToggle');
const notifIcon = document.getElementById('notifIcon');
const notifPanel = document.getElementById('notifPanel');

// helper to get permission state
function notificationPermissionState(){
  if (!("Notification" in window)) return 'unsupported';
  return Notification.permission; // 'granted' | 'denied' | 'default'
}

// update bell UI based on permission & enabled state
function updateNotifUI(){
  const perm = notificationPermissionState();
  const enabled = (perm === 'granted') && isNotificationsEnabledGlobally();
  // icon toggles between üîî (enabled) and üîï (disabled)
  notifIcon.textContent = enabled ? 'üîî' : 'üîï';
  notifToggleBtn.setAttribute('aria-pressed', String(enabled));
  // add glow class when enabled
  if (enabled) notifToggleBtn.classList.add('notif-enabled'); else notifToggleBtn.classList.remove('notif-enabled');
}

// global enable flag stored in localStorage (user preference)
const NOTIF_GLOBAL_KEY = `${BASE_KEY}_notif_enabled`;
function isNotificationsEnabledGlobally(){
  return localStorage.getItem(NOTIF_GLOBAL_KEY) === '1';
}
function setNotificationsEnabledGlobally(val){
  localStorage.setItem(NOTIF_GLOBAL_KEY, val ? '1' : '0');
  updateNotifUI();
}

// request permission then enable if granted
function requestNotificationPermissionAndEnable(){
  if (!("Notification" in window)){
    alert("This browser doesn't support notifications.");
    return;
  }
  Notification.requestPermission().then(permission => {
    if (permission === "granted"){
      setNotificationsEnabledGlobally(true);
      updateNotifUI();
      // brief visual feedback
      showToast("Notifications enabled");
    } else if (permission === "denied"){
      setNotificationsEnabledGlobally(false);
      updateNotifUI();
      alert("Notifications blocked. To enable, adjust site permissions in your browser.");
    } else {
      // default (user dismissed)
      setNotificationsEnabledGlobally(false);
      updateNotifUI();
    }
  });
}

// toggle button click: if permission granted toggle preference; else request permission
notifToggleBtn.addEventListener('click', (e)=>{
  const perm = notificationPermissionState();
  if (perm === 'granted'){
    const enabledNow = isNotificationsEnabledGlobally();
    setNotificationsEnabledGlobally(!enabledNow);
    if (!isNotificationsEnabledGlobally()) showToast("Reminders disabled");
    else showToast("Reminders enabled");
  } else {
    // ask for permission
    requestNotificationPermissionAndEnable();
  }
});

// small ephemeral toast for feedback
function showToast(msg){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.position = 'fixed';
  el.style.bottom = '18px';
  el.style.left = '50%';
  el.style.transform = 'translateX(-50%)';
  el.style.padding = '10px 14px';
  el.style.background = 'rgba(0,0,0,0.75)';
  el.style.color = 'white';
  el.style.borderRadius = '10px';
  el.style.zIndex = 9999;
  el.style.fontSize = '14px';
  document.body.appendChild(el);
  setTimeout(()=> el.style.opacity = '0', 2200);
  setTimeout(()=> document.body.removeChild(el), 2600);
}

/* =========================
   Table rebuild & helpers
   ========================= */
function rebuildTable(data){
  const headerRow = document.getElementById("headerRow");
  const tbody = document.getElementById("scheduleBody");
  headerRow.innerHTML = "";
  tbody.innerHTML = "";

  while (data.headers.length < 4) data.headers.push(getColMeta(data.headers.length).name);

  data.headers.forEach((text, idx) => {
    const th = document.createElement("th");
    th.contentEditable = "true";
    th.dataset.colIndex = idx;
    const meta = getColMeta(idx);
    th.dataset.placeholder = meta.name;
    th.textContent = text || meta.name;
    headerRow.appendChild(th);
  });

  const colCount = data.headers.length;
  (data.rows || []).forEach((rowArr, rowIndex) => {
    const tr = document.createElement("tr");
    for (let c=0;c<colCount;c++){
      const meta = getColMeta(c);
      const td = document.createElement("td");
      td.contentEditable = "true";
      td.dataset.colIndex = c;
      td.className = meta.className;
      td.dataset.placeholder = c===0 ? String(rowIndex+1) : meta.placeholder;
      td.textContent = rowArr && typeof rowArr[c] !== "undefined" ? rowArr[c] : "";
      if (c===1 || c===2) td.addEventListener('click', onTimeCellClick);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });

  if (tbody.children.length === 0) addRow();
  reindexSlots();
  saveTable();
}
function reindexSlots(){
  const tbody = document.getElementById("scheduleBody");
  Array.from(tbody.children).forEach((tr, idx) => {
    const slotCell = tr.children[0];
    const meta = getColMeta(0);
    if (slotCell) {
      slotCell.className = meta.className;
      slotCell.dataset.placeholder = String(idx+1);
      const existing = (slotCell.textContent || "").trim();
      if (!existing || !isNaN(existing)) slotCell.textContent = String(idx+1);
    }
  });
}

/* =========================
   Row/Column ops
   ========================= */
function addRow(auto=true){
  const tbody = document.getElementById("scheduleBody");
  const headerRow = document.getElementById("headerRow");
  const colCount = headerRow.children.length;
  const rowCount = tbody.children.length;

  let autoStart = "6:00 AM";
  let autoEnd = "6:45 AM";

  const gap = readGapForDay(currentDay);

  if (auto && rowCount > 0) {
    const prev = tbody.children[rowCount-1];
    const prevStart = prev.children[1]?.textContent.trim();
    const prevEnd = prev.children[2]?.textContent.trim();
    const prevEndPlusGap = addMinutes(prevEnd || prevStart, gap) || (prevEnd || prevStart) || "6:05 AM";
    autoStart = prevEndPlusGap;
    const dur = timeDiffMinutes(prevStart, prevEnd);
    const duration = (dur && dur > 0 && dur <= 8*60) ? dur : 45;
    autoEnd = addMinutes(autoStart, duration) || addMinutes(autoStart,45);
  }

  const tr = document.createElement("tr");
  for (let c=0;c<colCount;c++){
    const meta = getColMeta(c);
    const td = document.createElement("td");
    td.contentEditable = "true";
    td.dataset.colIndex = c;
    td.className = meta.className;
    td.dataset.placeholder = c===0 ? String(rowCount+1) : meta.placeholder;
    if (c===0) td.textContent = String(rowCount+1);
    else if (c===1) { td.textContent = autoStart; td.addEventListener('click', onTimeCellClick); }
    else if (c===2) { td.textContent = autoEnd; td.addEventListener('click', onTimeCellClick); }
    else td.textContent = "";
    tr.appendChild(td);
  }
  tbody.appendChild(tr);
  reindexSlots();
  saveTable();
}
function deleteRow(){
  const tbody = document.getElementById("scheduleBody");
  if (tbody.children.length <= 1) { alert("At least one row must remain."); return; }
  tbody.removeChild(tbody.lastElementChild);
  reindexSlots();
  saveTable();
}
function addColumn(){
  const headerRow = document.getElementById("headerRow");
  const tbody = document.getElementById("scheduleBody");
  const newIndex = headerRow.children.length;
  const meta = getColMeta(newIndex);
  const th = document.createElement("th");
  th.contentEditable = "true";
  th.dataset.colIndex = newIndex;
  th.dataset.placeholder = meta.name;
  th.textContent = meta.name;
  headerRow.appendChild(th);
  Array.from(tbody.children).forEach(tr=>{
    const td = document.createElement("td");
    td.contentEditable = "true";
    td.dataset.colIndex = newIndex;
    td.className = meta.className;
    td.dataset.placeholder = meta.placeholder;
    td.textContent = "";
    if (newIndex===1||newIndex===2) td.addEventListener('click', onTimeCellClick);
    tr.appendChild(td);
  });
  saveTable();
}
function deleteColumn(){
  const headerRow = document.getElementById("headerRow");
  const tbody = document.getElementById("scheduleBody");
  const colCount = headerRow.children.length;
  if (colCount <= 4) { alert("Cannot delete base columns (Slot / Start / End / Activity)."); return; }
  headerRow.removeChild(headerRow.lastElementChild);
  Array.from(tbody.children).forEach(tr=>{ if (tr.children.length >= colCount) tr.removeChild(tr.lastElementChild); });
  Array.from(headerRow.children).forEach((th,idx)=>th.dataset.colIndex = idx);
  Array.from(tbody.children).forEach((tr,rIdx)=>Array.from(tr.children).forEach((td,cIdx)=>{ td.dataset.colIndex = cIdx; const meta = getColMeta(cIdx); td.className = meta.className; td.dataset.placeholder = cIdx===0?String(rIdx+1):meta.placeholder; if (cIdx===1||cIdx===2){ /* ensure clickable */ td.removeEventListener('click', onTimeCellClick); td.addEventListener('click', onTimeCellClick); } }));
  saveTable();
}

/* batch helpers */
function addRowsN(n){ for (let i=0;i<n;i++) addRow(true); }
function deleteRowsN(n){ for (let i=0;i<n;i++){ const tbody=document.getElementById("scheduleBody"); if (tbody.children.length <=1) { alert("Cannot delete that many rows."); break; } deleteRow(); } }
function addColsN(n){ for (let i=0;i<n;i++) addColumn(); }
function deleteColsN(n){ for (let i=0;i<n;i++){ const headerRow = document.getElementById("headerRow"); if (headerRow.children.length <=4) { alert("Cannot delete base cols."); break; } deleteColumn(); } }

/* =========================
   Dropdowns (global handling)
   ========================= */
function closeAllMenus(){ document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.remove('open')); document.querySelectorAll('[data-menu-button]').forEach(b=>b.setAttribute('aria-expanded','false')); }
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-menu-button]');
  if (btn){
    e.stopPropagation();
    const key = btn.dataset.menuButton;
    const panel = document.querySelector(`.dropdown-menu[data-menu-panel="${key}"]`);
    if (!panel) return;
    const wasOpen = panel.classList.contains('open');
    closeAllMenus();
    if (!wasOpen){ panel.classList.add('open'); btn.setAttribute('aria-expanded','true'); panel.setAttribute('aria-hidden','false'); }
    return;
  }
  // handle notif dropdown specially (open/close)
  const notifBtn = e.target.closest('#notifToggle');
  if (notifBtn){
    e.stopPropagation();
    const panel = document.getElementById('notifPanel');
    const wasOpen = panel.classList.contains('open');
    closeAllMenus();
    if (!wasOpen){ panel.classList.add('open'); panel.setAttribute('aria-hidden','false'); }
    return;
  }
  // if clicked inside a dropdown-menu, do nothing (let sub-click handlers run)
  if (e.target.closest('.dropdown-menu')) return;
  // else clicked outside -> close menus
  closeAllMenus();
});

/* also close menus when pressing Escape */
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeAllMenus(); });

/* =========================
   Clear All
   ========================= */
document.getElementById('clearAllBtn').addEventListener('click', ()=>{
  if (!confirm("Clear all saved data for the entire week?")) return;
  DAYS.forEach(d => localStorage.removeItem(storageKeyForDay(d)));
  // reset per-day reminders and notified markers too (optional)
  DAYS.forEach(d => localStorage.removeItem(reminderKeyForDay(d)));
  Object.keys(localStorage).forEach(k => { if (k.startsWith(NOTIFIED_PREFIX)) localStorage.removeItem(k); });
  // reload current day
  loadForDay(currentDay);
});

/* =========================
   Gap panel behavior
   ========================= */
const gapPanel = document.getElementById('gapPanel');
const gapBtn = document.getElementById('gapBtn');
const gapLabel = document.getElementById('gapLabel');
const gapCustomInput = document.getElementById('gapCustomInput');
const gapApplyBtn = document.getElementById('gapApplyBtn');

document.querySelectorAll('#gapPanel .btn[data-gap]').forEach(b=>{
  b.addEventListener('click', (ev)=>{
    const val = parseInt(b.dataset.gap,10);
    if (!isNaN(val)) {
      gapCustomInput.value = val;
      applyGap(val);
    }
  });
});
gapApplyBtn.addEventListener('click', ()=>{
  const v = Math.max(0, Math.round(Number(gapCustomInput.value) || 0));
  applyGap(v);
});
function applyGap(minutes){
  minutes = Math.max(0, Math.round(Number(minutes) || 0));
  if (!currentDay) {
    localStorage.setItem(`${BASE_KEY}_active_gap`, String(minutes));
    gapLabel.textContent = `Gap: ${minutes} min`;
  } else {
    setGapForDay(currentDay, minutes, true);
  }
  closeAllMenus();
}

/* =========================
   Reminder (bell) panel behavior
   ========================= */
const reminderApplyBtn = document.getElementById('reminderApplyBtn');
const reminderCustomInput = document.getElementById('reminderCustomInput');

document.querySelectorAll('#notifPanel .btn[data-rem]').forEach(b=>{
  b.addEventListener('click', ()=>{
    const val = parseInt(b.dataset.rem,10);
    if (!isNaN(val)) {
      reminderCustomInput.value = val;
      applyReminder(val);
    }
  });
});
reminderApplyBtn.addEventListener('click', ()=>{
  const v = Math.max(0, Math.round(Number(reminderCustomInput.value) || 0));
  applyReminder(v);
});
function applyReminder(minutes){
  minutes = Math.max(0, Math.round(Number(minutes) || 0));
  if (!currentDay){
    // store a 'global default' for reminders if needed
    localStorage.setItem(`${BASE_KEY}_default_reminder`, String(minutes));
    showToast(`Default reminder set: ${minutes} min`);
  } else {
    setReminderForDay(currentDay, minutes, true);
    showToast(`Reminder for ${currentDay}: ${minutes} min`);
  }
  closeAllMenus();
}

/* =========================
   Time popup handling
   ========================= */
const timePopup = document.getElementById("timePopup");
const hourSelect = document.getElementById("hourSelect");
const minuteSelect = document.getElementById("minuteSelect");
const periodSelect = document.getElementById("periodSelect");
const applyTimeBtn = document.getElementById("applyTimeBtn");
const cancelTimeBtn = document.getElementById("cancelTimeBtn");
let activeTimeCell = null;

/* populate selectors */
(function initTimeSelectors(){
  for (let h=1; h<=12; h++){ const opt = document.createElement('option'); opt.value=h; opt.textContent=h; hourSelect.appendChild(opt); }
  for (let m=0; m<60; m+=5){ const opt = document.createElement('option'); opt.value=String(m).padStart(2,'0'); opt.textContent=String(m).padStart(2,'0'); minuteSelect.appendChild(opt); }
})();

function onTimeCellClick(e){
  const td = e.currentTarget || e.target.closest('td');
  if (!td) return;
  openTimePopupForCell(td);
}

function openTimePopupForCell(td){
  activeTimeCell = td;
  const text = (td.textContent || "").trim();
  const parsedMin = parseTimeToMinutes(text);
  let hour = 6, minute = 0, period = "AM";
  if (parsedMin != null){
    const tStr = minutesToTimeString(parsedMin);
    const parts = tStr.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/);
    if (parts){ hour = parseInt(parts[1],10); minute = parseInt(parts[2],10); period = parts[3]; }
  }
  hourSelect.value = hour; minuteSelect.value = String(minute).padStart(2,'0'); periodSelect.value = period;
  const rect = td.getBoundingClientRect();
  const popupHeight = timePopup.offsetHeight || 140;
  const popupWidth = 260;
  let top = rect.bottom + window.scrollY + 8;
  if (top + popupHeight > window.scrollY + window.innerHeight) top = rect.top + window.scrollY - popupHeight - 8;
  let left = rect.left + window.scrollX;
  if (left + popupWidth > window.scrollX + window.innerWidth - 8) left = window.scrollX + window.innerWidth - popupWidth - 8;
  timePopup.style.top = `${top}px`; timePopup.style.left = `${left}px`; timePopup.style.display = 'block'; timePopup.setAttribute('aria-hidden','false');
}
function closeTimePopup(){ timePopup.style.display = 'none'; timePopup.setAttribute('aria-hidden','true'); activeTimeCell = null; }

applyTimeBtn.addEventListener('click', ()=>{
  if (!activeTimeCell) return closeTimePopup();
  const h = parseInt(hourSelect.value,10);
  const m = parseInt(minuteSelect.value,10);
  const p = periodSelect.value;
  activeTimeCell.textContent = `${h}:${String(m).padStart(2,'0')} ${p}`;
  saveTable();
  closeTimePopup();
});
cancelTimeBtn.addEventListener('click', ()=> closeTimePopup());

document.addEventListener('click', (e) => {
  if (timePopup.style.display === 'block') {
    if (!timePopup.contains(e.target) && !e.target.classList.contains('time-col')) closeTimePopup();
  }
});
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeTimePopup(); closeAllMenus(); } });

/* delegate click on time cells using event delegation */
document.getElementById('scheduleBody').addEventListener('click',(e)=>{
  const td = e.target.closest('td');
  if (!td) return;
  const colIndex = parseInt(td.dataset.colIndex || "-1",10);
  if (colIndex === 1 || colIndex === 2) { e.stopPropagation(); openTimePopupForCell(td); }
});

/* Auto-save on edits */
document.getElementById('scheduleTable').addEventListener('input', (e) => {
  const tag = e.target.tagName;
  if (tag === "TD" || tag === "TH") saveTable();
});

/* =========================
   Week tabs, init & boot
   ========================= */
function buildTabs(){
  const container = document.getElementById('tabsContainer');
  container.innerHTML = '';
  DAYS.forEach(day => {
    const el = document.createElement('div');
    el.className = 'tab';
    el.textContent = day;
    el.dataset.day = day;
    el.addEventListener('click', ()=>{ 
      if (day === currentDay) return;
      if (currentDay) saveForDay(currentDay, captureTableToData());
      setActiveTab(day);
      loadForDay(day);
    });
    container.appendChild(el);
  });
}
function setActiveTab(day){
  currentDay = day;
  document.querySelectorAll('.tab').forEach(t => {
    if (t.dataset.day === day) t.classList.add('active'); else t.classList.remove('active');
  });
  const subtitle = document.querySelector('.subtitle'); if (subtitle) subtitle.textContent = `Editing: ${day} ‚Äî Click start/end to edit time ‚Ä¢ Auto-save per day`;
  const dayGap = readGapForDay(day);
  document.getElementById("gapLabel").textContent = `Gap: ${dayGap} min`;
  gapCustomInput.value = dayGap;
  // reminder UI update
  const rem = readReminderForDay(day);
  document.getElementById('reminderCustomInput').value = rem;
  // reset notified markers for this day to allow future notifications as fresh (optional)
  // (We keep global notified markers but they are date-aware)
  updateNotifUI();
}

/* load/create default */
function loadForDay(day){
  const raw = loadFromDay(day);
  let data = raw;
  if (!data || !Array.isArray(data.headers) || data.headers.length < 4) {
    data = {
      headers: ["Slot","Start Time","End Time","Activity"],
      rows: [
        ["1","6:00 AM","6:45 AM","Morning Routine"],
        ["2","6:50 AM","7:35 AM","Breakfast"],
        ["3","7:40 AM","8:25 AM","Study Block"]
      ],
      gapMinutes: 5,
      reminderMinutes: readReminderForDay(day)
    };
  } else {
    if (typeof data.gapMinutes !== "number") data.gapMinutes = data.gapMinutes ? Number(data.gapMinutes) : 5;
    if (typeof data.reminderMinutes !== "number") data.reminderMinutes = readReminderForDay(day);
  }
  setGapForDay(day, data.gapMinutes, false);
  rebuildTable(data);
}

/* initial day chooser */
function pickInitialDay(){
  const today = new Date();
  const idx = today.getDay(); // 0 Sun .. 6 Sat
  const mappingIndex = (idx + 6) % 7;
  return DAYS[mappingIndex];
}

/* =========================
   Toolbar (menu) item handling (rows/cols)
   ========================= */
document.querySelectorAll('.dropdown-menu .dropdown-item').forEach(item=>{
  item.addEventListener('click',(e)=>{
    const action = item.dataset.action;
    const count = parseInt(item.dataset.count||"0",10);
    if (action === "add-rows") addRowsN(count);
    else if (action === "delete-rows") deleteRowsN(count);
    else if (action === "add-cols") addColsN(count);
    else if (action === "delete-cols") deleteColsN(count);
    else if (action === "add-rows-custom"){ const n = parseInt(prompt("How many rows to add?","3")||"0",10); if (n>0) addRowsN(n); }
    else if (action === "delete-rows-custom"){ const n = parseInt(prompt("How many rows to delete?","1")||"0",10); if (n>0) deleteRowsN(n); }
    else if (action === "add-cols-custom"){ const n = parseInt(prompt("How many columns to add?","1")||"0",10); if (n>0) addColsN(n); }
    else if (action === "delete-cols-custom"){ const headerRow = document.getElementById("headerRow"); const maxDel = headerRow.children.length - 4; if (maxDel<=0) alert("No custom columns to delete."); else { const n = parseInt(prompt(`How many columns to delete? (max ${maxDel})`,"1")||"0",10); if (n>0) deleteColsN(Math.min(n,maxDel)); } }
    closeAllMenus();
  });
});

/* =========================
   Notification scheduling & firing
   ========================= */

/*
  Strategy:
  - Periodically (every 20s) scan currentDay table rows.
  - For each row, parse Start Time (col index 1). Compute minutes since midnight.
  - Compute target = startMinutes - reminderMinutes.
  - If current local time minutes equals target (within check window) and we haven't already notified for that row+startMinutes+date, then:
      - Fire a Notification (minimal body). Store a localStorage flag to prevent duplicates for that day+row+startStartMinutes.
  - Notified key: NOTIFIED_PREFIX + "_" + YYYYMMDD + "_" + day + "_" + rowIndex + "_" + startMinutes
*/

function todayDateKey(){
  const d = new Date();
  const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
  return `${y}${m}${day}`;
}
function notifiedStorageKey(day, rowIndex, startMinutes){
  return `${NOTIFIED_PREFIX}_${todayDateKey()}_${day}_${rowIndex}_${startMinutes}`;
}

function sendInPageNotification(day, rowIndex, startText){
  // minimal notification (user wanted only icon, but browsers typically show app name & small body)
  if (!("Notification" in window)) return;
  if (Notification.permission !== 'granted') return;
  // create a short notification; body minimal
  try {
    const title = "Schedy";
    const options = { body: `Upcoming at ${startText}`, tag: `${day}_${rowIndex}_${startText}`, renotify: false };
    new Notification(title, options);
  } catch(e){
    console.warn("Notification failed:", e);
  }
}

function checkAndFireReminders(){
  try {
    if (!currentDay) return;
    // only proceed if user enabled globally and permission granted
    if (!isNotificationsEnabledGlobally()) return;
    if (Notification.permission !== 'granted') {
      // if denied, reflect UI
      updateNotifUI();
      return;
    }
    const tbody = document.getElementById('scheduleBody');
    const reminderMinutes = readReminderForDay(currentDay);
    const now = new Date();
    const nowMinutes = now.getHours()*60 + now.getMinutes();
    // we run every ~20 seconds; allow match if nowMinutes equals target OR nowMinutes equals target and seconds near 0
    Array.from(tbody.children).forEach((tr, rowIndex) => {
      const startCell = tr.children[1];
      if (!startCell) return;
      const startText = (startCell.textContent || "").trim();
      const startMin = parseTimeToMinutes(startText);
      if (startMin == null) return;
      // compute target minute
      const target = startMin - reminderMinutes;
      // handle wrap-around negative
      const targetNormalized = ((target % (24*60)) + (24*60)) % (24*60);
      // to allow seconds slipping, compute difference in minutes and seconds
      // we'll consider a hit if absolute(nowTotalMinutes - targetNormalized) === 0 and seconds between 0..59
      const nowTotalMinutes = nowMinutes;
      if (nowTotalMinutes === targetNormalized) {
        // check if already notified
        const key = notifiedStorageKey(currentDay, rowIndex, startMin);
        if (!localStorage.getItem(key)){
          // fire notification
          sendInPageNotification(currentDay, rowIndex, startText);
          localStorage.setItem(key, String(Date.now()));
        }
      }
    });
  } catch(err){
    console.error("Reminder check error:", err);
  }
}

// run first after startup and then every 20 seconds
let reminderInterval = null;
function startReminderLoop(){
  if (reminderInterval) clearInterval(reminderInterval);
  reminderInterval = setInterval(checkAndFireReminders, 20000);
  // also run immediately
  setTimeout(checkAndFireReminders, 1200);
}
function stopReminderLoop(){
  if (reminderInterval) clearInterval(reminderInterval);
  reminderInterval = null;
}

/* =========================
   Init app
   ========================= */
function initApp(){
  initTheme();
  // ensure default global gap exists
  if (!localStorage.getItem(`${BASE_KEY}_active_gap`)) localStorage.setItem(`${BASE_KEY}_active_gap`, "5");
  // ensure default global reminder exists
  if (!localStorage.getItem(`${BASE_KEY}_default_reminder`)) localStorage.setItem(`${BASE_KEY}_default_reminder`, "5");
  buildTabs();
  const initial = pickInitialDay();
  setActiveTab(initial);
  loadForDay(initial);
  // update notif UI according to stored preference & permission
  updateNotifUI();
  // begin reminder loop
  startReminderLoop();
  // add click handlers to close notif panel buttons to close after choice
  document.querySelectorAll('#notifPanel .btn').forEach(b => b.addEventListener('click', ()=> closeAllMenus()));
}
initApp();

/* expose helpers for quick console testing */
window.addRow = addRow; window.deleteRow = deleteRow;
window.addColumn = addColumn; window.deleteColumn = deleteColumn;
window.saveForCurrentDay = ()=> saveForDay(currentDay, captureTableToData());

// Make sure notif UI reflects permission changes if user changes browser settings live (best-effort)
setInterval(updateNotifUI, 5000);

</script>
</body>
</html>
